<html>

<head>
    <title>RWI</title>
    <meta charset="utf-8"></meta>
</head>

<body>
    <center>
        <h1>There is RWI (Red Web Image) Demo</h1>
    </center>
    <center>
        <h2>对，我在盯着你看～～～</h2>
    </center>
    <center>
        <canvas id="webGL" width="2000px" height="1500px" style="width:70%"></canvas>
    </center>
    <script>
        var canvasElement = document.getElementById("webGL");
        var context = canvasElement.getContext('webgl');

        var vertexShaderSource =
            "attribute vec2 pos;" +
            "attribute vec2 texPos;" +
            "varying vec2 varyTexPos;" +
            "void main(){" +
            "    gl_Position = vec4(pos.xy,0.0,1.0);" +
            "    varyTexPos = texPos;" +
            "}";

        var fragmentShaderSource =
            "precision lowp float;" +
            "varying vec2 varyTexPos;" +
            "uniform sampler2D mainTexture;" +
            "uniform float floatVal;" +
            "void main(){" +
            "    float stongth = 0.2;" +
            "    vec2 uv = varyTexPos.xy;" +
            "    float waveu = sin((uv.y + floatVal) * 20.0) * 0.5 * 0.05 * stongth;" +
            "    gl_FragColor = texture2D(mainTexture, uv + vec2(waveu, 0));" +
            "}";

        var program = initShader(context, vertexShaderSource, fragmentShaderSource);

        /** floatVal **/

        /** floatVal **/

        /** start纹理坐标 **/
        var dataCoor = new Float32Array([0.0, 1.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0]);
        var bufferCoor = context.createBuffer();

        context.bindBuffer(context.ARRAY_BUFFER, bufferCoor);
        context.bufferData(context.ARRAY_BUFFER, dataCoor, context.STATIC_DRAW);

        var posCoorLocation = context.getAttribLocation(program, 'texPos');
        context.vertexAttribPointer(posCoorLocation, 2, context.FLOAT, false, 0, 0);
        context.enableVertexAttribArray(posCoorLocation);
        /** end纹理坐标 **/

        /** start设置定点数据 **/
        var data = new Float32Array([-1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0]);
        var buffer = context.createBuffer();

        context.bindBuffer(context.ARRAY_BUFFER, buffer);
        context.bufferData(context.ARRAY_BUFFER, data, context.STATIC_DRAW);

        var posLocation = context.getAttribLocation(program, 'pos');
        context.vertexAttribPointer(posLocation, 2, context.FLOAT, false, 0, 0);
        context.enableVertexAttribArray(posLocation);
        /** end设置定点数据 **/

        /** start设置索引数据 **/
        var indicesData = new Uint8Array([0, 1, 2, 0, 2, 3]);
        var indexBuffer = context.createBuffer();
        context.bindBuffer(context.ELEMENT_ARRAY_BUFFER, indexBuffer);
        context.bufferData(context.ELEMENT_ARRAY_BUFFER, indicesData, context.STATIC_DRAW);
        /** end设置索引数据 **/

        
        loadImage("miaowu.jpg", function(img) {
            /** start贴图 **/
            var texture = context.createTexture();
            context.pixelStorei(context.UNPACK_FLIP_Y_WEBGL,1);
            context.activeTexture(context.TEXTURE0);
            context.bindTexture(context.TEXTURE_2D,texture);

            context.texParameteri(context.TEXTURE_2D,context.TEXTURE_MIN_FILTER,context.LINEAR);
            context.texParameteri(context.TEXTURE_2D,context.TEXTURE_MAG_FILTER,context.LINEAR);
            context.texParameteri(context.TEXTURE_2D,context.TEXTURE_WRAP_S,context.CLAMP_TO_EDGE);
            context.texParameteri(context.TEXTURE_2D,context.TEXTURE_WRAP_T,context.CLAMP_TO_EDGE);

            context.texImage2D(context.TEXTURE_2D,0,context.RGBA,context.RGBA,context.UNSIGNED_BYTE,img);

            var texLocation = context.getUniformLocation(program,'mainTexture');
            context.uniform1i(texLocation,0);

            draw()
        });
        /** end贴图 **/

        function draw()
        {
            setInterval(run,10);
        }

        var changeVal = 0; 

        function run(){
            context.clearColor(1.0,1.0,1.0,1.0);
            context.clear(context.COLOR_BUFFER_BIT);

            var floatValLocation = context.getUniformLocation(program,'floatVal');
            changeVal = changeVal + 0.005;
            context.uniform1f(floatValLocation,changeVal);

            context.drawElements(context.TRIANGLES, indicesData.length, context.UNSIGNED_BYTE, 0);
        }
    

        function initShader(gl, vertexShaderSource, fragmentShaderSource) {
            var vertexShader = gl.createShader(gl.VERTEX_SHADER);
            var fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);

            gl.shaderSource(vertexShader, vertexShaderSource);
            gl.shaderSource(fragmentShader, fragmentShaderSource);

            gl.compileShader(vertexShader);
            gl.compileShader(fragmentShader);

            var program = gl.createProgram();
            gl.attachShader(program, vertexShader);
            gl.attachShader(program, fragmentShader);

            gl.linkProgram(program);

            gl.useProgram(program);

            console.error(gl.getShaderInfoLog(vertexShader));
            console.error(gl.getShaderInfoLog(fragmentShader));

            return program;
        }

        function loadImage(url, cb) {
            var img = new Image();
            img.onload = function() {
                cb(img);
            };
            img.src = url;
        }
    </script>
</body>

</html>

