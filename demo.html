<html>

<head>
    <title>RWI</title>
    <meta charset="utf-8"></meta>

    <script src="lib/GL/GLProgram.js"></script>
    <script src="lib/GL/GLShader.js"></script>
    <script src="lib/GL/GLTexture.js"></script>
    <script src="lib/GL/GLBuffer.js"></script>
</head>

<body>

    <canvas id="webGL" width="2000px" height="1500px" style="width:70%"></canvas>

    <canvas id="webGL2" width="2000px" height="1500px" style="width:70%"></canvas>

    <script id="vshader" type="x-shader/x-vertex">
        attribute vec2 pos;
        attribute vec2 texPos;
        varying vec2 varyTexPos;
        void main(){
            gl_Position = vec4(pos.xy,0.0,1.0);
            varyTexPos = texPos;
        }
    </script>
    <script id="fshader" type="x-shader/x-vertex">
        precision lowp float;
        varying vec2 varyTexPos;
        uniform sampler2D mainTexture;
        uniform float floatVal;

        void main(){
            float stongth = 1.0;
            vec2 uv = varyTexPos.xy;
            float waveu = sin((uv.y + floatVal) * 20.0) * 0.5 * 0.05 * stongth;
            gl_FragColor = texture2D(mainTexture, uv + vec2(waveu, waveu));
        }
    </script>
    <script>
        var canvasElement2 = document.getElementById("webGL2");
        var context2 = canvasElement2.getContext('webgl' || 'experimental-webgl');

        var myProgram2 = Object.create(GLProgram);
        myProgram2.Init(context2);

        var VertexShader2 = Object.create(GLShader);
        VertexShader2.Init(context2,context2.VERTEX_SHADER,document.getElementById("vshader").textContent);
        VertexShader2.CompileShader();

        var FragmentShader2 = Object.create(GLShader);
        FragmentShader2.Init(context2,context2.FRAGMENT_SHADER,document.getElementById("fshader").textContent);
        FragmentShader2.CompileShader();

        myProgram2.AddShader(VertexShader2);
        myProgram2.AddShader(FragmentShader2);

        myProgram2.LinkProgram();
        myProgram2.UseProgram();

        context2.clear(context2.COLOR_BUFFER_BIT);
        context2.clearColor(1.0,1.0,0.0,1.0);
        
    </script>
    <script>
        var canvasElement = document.getElementById("webGL");
        var context = canvasElement.getContext('webgl' || 'experimental-webgl');

        /**** start 创建Program ****/
        var myProgram = Object.create(GLProgram);
        myProgram.Init(context);

        var VertexShader = Object.create(GLShader);
        VertexShader.Init(context,context.VERTEX_SHADER,document.getElementById("vshader").textContent);
        VertexShader.CompileShader();

        var FragmentShader = Object.create(GLShader);
        FragmentShader.Init(context,context.FRAGMENT_SHADER,document.getElementById("fshader").textContent);
        FragmentShader.CompileShader();

        myProgram.AddShader(VertexShader);
        myProgram.AddShader(FragmentShader);

        myProgram.LinkProgram();
        myProgram.UseProgram();
        /**** end 创建Program ****/
        var program = myProgram.programId;




        
        

        /** start纹理坐标 **/
        var dataCoor = new Float32Array([0.0, 1.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0]);
        var CoorBuffer = Object.create(GLBuffer);
        CoorBuffer.Init(context);
        CoorBuffer.SetBufferData(dataCoor,context.ARRAY_BUFFER);
        var bufferCoor = CoorBuffer.bufferId;

        var posCoorLocation = context.getAttribLocation(program, 'texPos');
        context.vertexAttribPointer(posCoorLocation, 2, context.FLOAT, false, 0, 0);
        context.enableVertexAttribArray(posCoorLocation);
        /** end纹理坐标 **/





        /** start设置定点数据 **/
        var data = new Float32Array([-1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0]);
        var VertexBuffer = Object.create(GLBuffer);
        VertexBuffer.Init(context);
        VertexBuffer.SetBufferData(data,context.ARRAY_BUFFER);
        var buffer = VertexBuffer.bufferId;


        var posLocation = context.getAttribLocation(program, 'pos');
        context.vertexAttribPointer(posLocation, 2, context.FLOAT, false, 0, 0);
        context.enableVertexAttribArray(posLocation);
        /** end设置定点数据 **/






        /** start设置索引数据 **/
        var indicesData = new Uint8Array([0, 1, 2, 0, 2, 3]);
        var IndexBuffer = Object.create(GLBuffer);
        IndexBuffer.Init(context);
        IndexBuffer.SetBufferData(indicesData,context.ELEMENT_ARRAY_BUFFER);
        var indexBuffer = IndexBuffer.bufferId;
        /** end设置索引数据 **/


        


        loadImage("http://image.dcniupai.com/o_1bckbio6ebv9seca4gk6102qpg.jpg", function(img) {
            /** start贴图 **/
            var GLTextureObj = Object.create(GLTexture);
            GLTextureObj.Init(context);
            GLTextureObj.SetImage(img,context.TEXTURE0);
            var texture = GLTextureObj.textureId;

            context.clearColor(0.0, 1.0, 1.0, 1.0);
            context.clear(context.COLOR_BUFFER_BIT);

            var texLocation = context.getUniformLocation(program, 'mainTexture');
            context.uniform1i(texLocation, 0);

            draw();
        });
        /** end贴图 **/

        function draw()
        {
            setInterval(run,30);
        }

        var changeVal = 0;

        function run(){
            context.clearColor(1.0,1.0,1.0,1.0);
            context.clear(context.COLOR_BUFFER_BIT);

            var floatValLocation = context.getUniformLocation(program,'floatVal');
            changeVal = changeVal + 0.005;
            context.uniform1f(floatValLocation,changeVal);

            context.drawElements(context.TRIANGLES, indicesData.length, context.UNSIGNED_BYTE, 0);
        }

        function loadImage(url, cb) {
            var img = new Image();
            img.crossOrigin = "Anonymous"
            img.src = url;
            img.onload = function() {
                cb(img);
            };
        }
    </script>
</body>

</html>
